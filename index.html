<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Global Semiconductor Industrial Policy Tracker</title>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 background */
      --card: #111827;      /* gray-900 card background */
      --muted: #9ca3af;     /* gray-400 text */
      --fg: #e5e7eb;        /* gray-200 foreground text */
      --accent: #60a5fa;    /* blue-400 links/buttons */
      --accent-2: #34d399;  /* emerald-400 (unused in current code) */
      --border: #1f2937;    /* gray-800 borders */
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
    }
    h1 { font-size: clamp(22px, 3vw, 32px); margin: 0; letter-spacing: 0.2px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);    /* fixed 'solid' typo */
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }
    .toolbar input {
      flex: 1 1 260px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #0b1220;
      color: var(--fg);
      border: 1px solid var(--border);    /* fixed 'solid' typo */
      height: 38px;
      font-size: 15px;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
    }
    .toolbar .btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);    /* fixed 'solid' typo */
      background: #0b1220;
      color: var(--fg);
      cursor: pointer;
      height: 38px;
      font-size: 15px;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
    }
    .toolbar .btn:hover { border-color: #334155; }
    .disclaimer {
      color: var(--muted);
      font-size: 14px;
      margin: 6px 0 16px;
    }
    table { width: 100%; border-collapse: collapse; }   /* fixed 'wth' to 'width' */
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);           /* fixed 'solid' typo */
      vertical-align: top;
    }
    th {
      text-align: left;
      font-weight: 600;
      color: var(--muted);
    }
    tr:hover td { background: rgba(255,255,255,0.02); }
    /* Ensure Effective Period column wraps and doesn't force table too wide */
    .home-table th:nth-child(4),
    .home-table td:nth-child(4) {
      width: 200px;
      white-space: normal;
      word-break: break-word;
    }
    .detail-table th {
      white-space: nowrap;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);   /* fixed 'solid' typo */
      background: #0b1220;
      color: var(--muted);
      font-size: 12px;
    }
    .muted { color: var(--muted); }
    .breadcrumb {
      font-size: 14px;
      margin-bottom: 12px;
    }
    .breadcrumb a { color: var(--muted); }
    .stat {
      display: inline-block;
      padding: 2px 8px;
      background: #0b1220;
      border: 1px solid var(--border);   /* fixed 'solid' typo */
      border-radius: 999px;
      font-variant-numeric: tabular-nums;
    }
    .footer {
      margin-top: 24px;
      color: var(--muted);
      font-size: 14px;
    }
    /* Responsive: hide elements with class "he-sm" on narrow screens */
    @media (max-width: 640px) {
      .he-sm { display: none; }                   /* hide any element marked he-sm */
      th.he-sm, td.he-sm { display: none; }       /* specifically hide table cells in that class */
      .toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
      }
      .toolbar input,
      .toolbar .btn {
        height: 30px;
        font-size: 16px; /* prevent iOS zoom */
        padding: 4px 8px;
        border-radius: 6px;
        line-height: 20px;
      }
      h1 { font-size: 18px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Global Semiconductor Industrial Policy Tracker</h1>
      <nav>
        <!-- Link back to main personal site -->
        <a href="https://ranzhuo17.github.io/" title="Back to main site">‚Ü©Ô∏é Main site</a>
      </nav>
    </header>

    <p class="disclaimer">
      Data is compiled from publicly available sources and will be updated periodically.
      It may not be fully comprehensive, and some policies across regions or time periods may not be captured.
    </p>

    <!-- Main content container (card) -->
    <div id="app" class="card" aria-live="polite"></div>
  </div>

 <script>
  // ================== DATA LOADING ==================
  let SUBSIDIES = [];
  async function loadData() {
    try {
      const res = await fetch('policies.json', { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      // Keep one entry per row (already produced by your converter). If any row has multiple
      // subprojects jammed in via slashes (unlikely now), split them into separate entries.
      SUBSIDIES = Array.isArray(data) ? data.flatMap(s => {
        if (s.subproject_name && s.subproject_name.includes('/')) {
          const parts = s.subproject_name.split('/').map(p => p.trim()).filter(Boolean);
          if (parts.length > 1) {
            return parts.map(name => ({ ...s, subproject_name: name }));
          }
        }
        return s;
      }) : [];
    } catch(err) {
      console.error('Failed to load policies.json', err);
      SUBSIDIES = [];
      const app = document.getElementById('app');
      if (app && !app.dataset.errorShown) {
        app.dataset.errorShown = '1';
        app.innerHTML = `<p class="muted">Couldn‚Äôt load data. Add <code>policies.json</code> (an array of policy objects) to populate this page.</p>`;
      }
    }
  }

  // ================== UTILITIES ==================
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function getRoute() {
    const hash = location.hash.replace(/^#\/?/, '');
    const parts = hash.split('/').filter(Boolean);
    // Routes:
    //   "" or "home"               -> home
    //   "project/{projectId}"      -> project detail
    //   "subproject/{pId}/{sId}"   -> subproject detail
    if (parts.length === 0 || parts[0] === 'home') return { route: 'home' };
    if (parts[0] === 'project' && parts[1]) return { route: 'project', pid: parts[1] };
    if (parts[0] === 'subproject' && parts[1] && parts[2]) return { route: 'subproject', pid: parts[1], sid: parts[2] };
    // Back-compat: old "subsidy/{id}" route points to project page
    if (parts[0] === 'subsidy' && parts[1]) return { route: 'project', pid: parts[1] };
    return { route: 'home' };
  }

  function navigate(to) {
    location.hash = to.startsWith('#') ? to : '#/' + to.replace(/^\//,'');
  }

  function normalizeSources(srcs) {
    if (!srcs) return [];
    if (Array.isArray(srcs)) return srcs;
    if (typeof srcs === 'string') {
      try {
        const maybe = JSON.parse(srcs);
        if (Array.isArray(maybe)) return maybe;
      } catch (_) {}
      const out = [];
      const mdRe = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
      let mdMatch;
      let consumed = srcs;
      while ((mdMatch = mdRe.exec(srcs)) !== null) {
        out.push({ label: mdMatch[1], url: mdMatch[2] });
        consumed = consumed.replace(mdMatch[0], ' ');
      }
      const urlRe = /https?:\/\/[^\s<>"')\]]+/g;
      let urlMatch;
      while ((urlMatch = urlRe.exec(consumed)) !== null) {
        out.push({ url: urlMatch[0] });
      }
      if (out.length === 0) {
        const parts = srcs.split(/\s*[;|]\s*/).filter(Boolean);
        for (const p of parts) {
          const m = p.match(/^(.*?)\s*,\s*(https?:\/\/.+)$/);
          if (m) out.push({ label: m[1], url: m[2] });
          else if (/^https?:\/\//i.test(p)) out.push({ url: p });
          else out.push({ label: p });
        }
      }
      return out;
    }
    return [srcs];
  }

  function renderSourcesList(srcs) {
    const list = normalizeSources(srcs);
    if (!list.length) return '(none)';
    return list.map(obj => {
      const text = obj.label ? `${obj.label}` : `${obj.url}`;
      if (obj.url) {
        return `<a href="${obj.url}" target="_blank" rel="noopener noreferrer">${text}</a>`;
      }
      return text;
    }).join(' ¬∑ ');
  }

  // ================== RENDERERS ==================
  function renderHome() {
    const app = $('#app');
    app.innerHTML = '';

    const toolbar = document.createElement('div');
    toolbar.className = 'toolbar';
    toolbar.innerHTML = `
      <input id="q" type="search" placeholder="Search project, subproject, country, year‚Ä¶" aria-label="Search policies" />
      <button class="btn" id="clearBtn" type="button">Clear</button>
    `;

    const table = document.createElement('table');
    table.className = 'home-table';
    table.innerHTML = `
      <thead>
        <tr>
          <th>Project Name (Click for details)</th>
          <th>Subproject Name</th>
          <th>Year Announced</th>
          <th>Effective Period</th>
          <th>Country/Region</th>
          <th>Type & Status</th>
          <th>Numbers</th>
          <th class="he-sm">Targeted Entities</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    `;

    app.append(toolbar, table);

    const rows = $('#rows');

    function draw(filter = '') {
      const q = filter.trim().toLowerCase();
      const items = SUBSIDIES
        .filter(s => {
          if (!q) return true;
          const haystack = [
            s.project_name,
            s.subproject_name,
            s.country_region,
            s.effective_period,
            s.type_and_status,
            s.targeted_entities,
            s.notes,
            ...(Array.isArray(s.distributions) ? s.distributions.map(d => d.distribution_name) : [])
          ].filter(Boolean).join(' ').toLowerCase();
          return haystack.includes(q);
        })
        .sort((a, b) => String(a.project_name ?? '').localeCompare(String(b.project_name ?? '')));

      rows.innerHTML = items.map(s => {
        const hasSub = Boolean((s.subproject_name && s.subproject_name.trim()) || (s.subproject_id && String(s.subproject_id).trim()));
        const projectLink = hasSub
          ? `${s.project_name ?? ''}` // NOT a link when subproject exists
          : `<a href="#/project/${s.project_id}" aria-label="Open ${s.project_name}">${s.project_name ?? ''}</a>`;
        const subprojectLink = hasSub
          ? `<a href="#/subproject/${s.project_id}/${s.subproject_id}" aria-label="Open ${s.subproject_name}">${s.subproject_name ?? ''}</a>`
          : ``;

        return `
          <tr>
            <td>${projectLink}</td>
            <td>${subprojectLink}</td>
            <td>${s.year_announced ?? ''}</td>
            <td>${s.effective_period ?? ''}</td>
            <td>${s.country_region ?? ''}</td>
            <td>${s.type_and_status ?? ''}</td>
            <td>${s.numbers ?? ''}</td>
            <td class="he-sm">${s.targeted_entities ?? ''}</td>
          </tr>
        `;
      }).join('');
    }

    const qInput = $('#q');
    const clearBtn = $('#clearBtn');
    qInput.addEventListener('input', () => draw(qInput.value));
    clearBtn.addEventListener('click', () => {
      qInput.value = '';
      draw('');
      qInput.focus();
    });

    draw('');
  }

  function renderProject(projectId) {
    const app = $('#app');

    // Main project row: same project_id, EMPTY subproject_id/name
    const isEmpty = v => v == null || String(v).trim() === '';
    const main = SUBSIDIES.find(x =>
      String(x.project_id) === String(projectId) &&
      (isEmpty(x.subproject_id) && isEmpty(x.subproject_name))
    );

    // Fallback: if no explicit "main" row, use any row with that project_id
    const anchor = main || SUBSIDIES.find(x => String(x.project_id) === String(projectId));

    if (!anchor) {
      app.innerHTML = `<div class="breadcrumb"><a href="#/">‚Üê Back</a></div><p>Project not found.</p>`;
      return;
    }

    // Subprojects list
    const subs = SUBSIDIES
      .filter(x => String(x.project_id) === String(projectId))
      .filter(x => !(isEmpty(x.subproject_id) && isEmpty(x.subproject_name)))
      .map(x => ({ name: x.subproject_name || '(unnamed)', id: x.subproject_id }))
      // Deduplicate by (name,id)
      .filter((v, i, arr) => arr.findIndex(w => w.name === v.name && String(w.id) === String(v.id)) === i)
      .sort((a, b) => String(a.name).localeCompare(String(b.name)));

    const s = anchor; // use 's' for consistency with detail renderer below

    app.innerHTML = `
      <div class="breadcrumb"><a href="#/">‚Üê Back to all policies</a></div>
      <h2 style="margin: 6px 0 16px; font-size: 22px;">${s.project_name}</h2>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom: 14px;">
        <span class="pill">üåç ${s.country_region ?? ''}</span>
        <span class="pill">üìÖ ${s.effective_period ?? ''}</span>
        <span class="pill">üí∞ ${s.numbers ?? ''}</span>
        <span class="pill">üìù <strong>Details:</strong> ${s.notes ?? ''}</span>
      </div>
      ${s.sources ? `<div class="muted" style="margin-bottom:12px">
         Sources: ${renderSourcesList(s.sources)}
       </div>` : ''}

      ${subs.length ? `
        <div class="card" style="margin-bottom:16px;">
          <h3 style="margin:0 0 10px; font-size:18px;">Subprojects</h3>
          <ul style="margin:0; padding-left:18px;">
            ${subs.map(sp => `
              <li><a href="#/subproject/${projectId}/${sp.id}">${sp.name}</a></li>
            `).join('')}
          </ul>
        </div>
      ` : ''}

      <div class="card" style="padding:0; overflow:auto;">
        <table class="detail-table">
          <thead>
            <tr>
              <th>Distribution Name</th>
              <th>Year Announced</th>
              <th>Effective Period</th>
              <th>Country/Region</th>
              <th>Type & Status</th>
              <th>Numbers</th>
              <th>Targeted Entities</th>
              <th>Notes</th>
              <th>Sources</th>
            </tr>
          </thead>
          <tbody>
            ${(s.distributions ?? []).map(r => `
              <tr>
                <td>${r.distribution_name ?? ''}</td>
                <td>${r.year_announced ?? ''}</td>
                <td>${r.effective_period ?? ''}</td>
                <td>${r.country_region ?? ''}</td>
                <td>${r.type_and_status ?? ''}</td>
                <td>${r.numbers ?? ''}</td>
                <td>${r.targeted_entities ?? ''}</td>
                <td>${r.notes ?? ''}</td>
                <td>${renderSourcesList(r.sources || s.sources)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  function renderSubproject(projectId, subprojectId) {
    const app = $('#app');
    const s = SUBSIDIES.find(x =>
      String(x.project_id) === String(projectId) &&
      String(x.subproject_id) === String(subprojectId)
    );

    // Also locate parent for breadcrumb/name continuity
    const parent = SUBSIDIES.find(x =>
      String(x.project_id) === String(projectId) &&
      (!x.subproject_id || String(x.subproject_id).trim() === '')
    );

    if (!s) {
      app.innerHTML = `<div class="breadcrumb">
          <a href="#/">‚Üê Back</a>
          ${parent ? ` ¬∑ <a href="#/project/${projectId}">${parent.project_name}</a>` : ''}
        </div>
        <p>Subproject not found.</p>`;
      return;
    }

    app.innerHTML = `
      <div class="breadcrumb">
        <a href="#/">‚Üê Back to all policies</a>
        ${parent ? ` ¬∑ <a href="#/project/${projectId}">${parent.project_name}</a>` : ''}
      </div>
      <h2 style="margin: 6px 0 0; font-size: 22px;">${s.project_name}</h2>
      <h3 style="margin: 2px 0 12px; font-size: 18px; color: var(--muted);">Subproject: ${s.subproject_name ?? ''}</h3>

      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom: 14px;">
        <span class="pill">üåç ${s.country_region ?? ''}</span>
        <span class="pill">üìÖ ${s.effective_period ?? ''}</span>
        <span class="pill">üí∞ ${s.numbers ?? ''}</span>
        <span class="pill">üìù <strong>Details:</strong> ${s.notes ?? ''}</span>
      </div>
      ${s.sources ? `<div class="muted" style="margin-bottom:12px">
         Sources: ${renderSourcesList(s.sources)}
       </div>` : ''}

      <div class="card" style="padding:0; overflow:auto;">
        <table class="detail-table">
          <thead>
            <tr>
              <th>Distribution Name</th>
              <th>Year Announced</th>
              <th>Effective Period</th>
              <th>Country/Region</th>
              <th>Type & Status</th>
              <th>Numbers</th>
              <th>Targeted Entities</th>
              <th>Notes</th>
              <th>Sources</th>
            </tr>
          </thead>
          <tbody>
            ${(s.distributions ?? []).map(r => `
              <tr>
                <td>${r.distribution_name ?? ''}</td>
                <td>${r.year_announced ?? ''}</td>
                <td>${r.effective_period ?? ''}</td>
                <td>${r.country_region ?? ''}</td>
                <td>${r.type_and_status ?? ''}</td>
                <td>${r.numbers ?? ''}</td>
                <td>${r.targeted_entities ?? ''}</td>
                <td>${r.notes ?? ''}</td>
                <td>${renderSourcesList(r.sources || s.sources)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  // ================== ROUTER ==================
  function router() {
    const { route, pid, sid } = getRoute();
    if (route === 'project' && pid) return renderProject(pid);
    if (route === 'subproject' && pid && sid) return renderSubproject(pid, sid);
    return renderHome();
  }

  window.addEventListener('hashchange', router);
  window.addEventListener('DOMContentLoaded', async () => {
    await loadData();
    router();
  });
</script>

</body>
</html>
