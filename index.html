<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Global Semiconductor Industrial Policy Tracker</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --card: #111827; /* gray-900 */
      --muted: #9ca3af; /* gray-400 */
      --fg: #e5e7eb; /* gray-200 */
      --accent: #60a5fa; /* blue-400 */
      --accent-2: #34d399; /* emerald-400 */
      --border: #1f2937; /* gray-800 */
    }
    body { margin: 0; background: var(--bg); color: var(--fg); font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 20px; }
    h1 { font-size: clamp(22px, 3vw, 32px); margin: 0; letter-spacing: 0.2px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .toolbar { display:flex; gap:12px; flex-wrap: wrap; align-items:center; margin-bottom: 12px; }
   .toolbar input {
  flex: 1 1 260px;
  padding: 8px 10px;
  border-radius: 10px;
  background: #0b1220;
  color: var(--fg);
  border: 1px sol var(--border);
  height: 38px;
  font-size: 15px;
  box-sizing: border-box;
  -webkit-appearance: none;
  appearance: none;
}
   .toolbar .btn {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px sol var(--border);
  background: #0b1220;
  color: var(--fg);
  cursor: pointer;
  height: 38px;
  font-size: 15px;
  box-sizing: border-box;
  -webkit-appearance: none;
  appearance: none;
}
    .disclaimer {
  color: var(--muted);
  font-size: 14px;
  margin: 6px 0 16px;
}
    .toolbar .btn:hover { border-color: #334155; }
    table { wth: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px sol var(--border); vertical-align: top; }
    th { text-align: left; font-weight: 600; color: var(--muted); }
    tr:hover td { background: rgba(255,255,255,0.02); }
    .pill { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; border: 1px sol var(--border); background: #0b1220; color: var(--muted); font-size: 12px; }
    .muted { color: var(--muted); }
    .breadcrumb { font-size: 14px; margin-bottom: 12px; }
    .breadcrumb a { color: var(--muted); }
    .stat { display:inline-block; padding: 2px 8px; background: #0b1220; border:1px sol var(--border); border-radius: 999px; font-variant-numeric: tabular-nums; }
    .footer { margin-top: 24px; color: var(--muted); font-size: 14px; }
    @media (max-wth: 640px){
  .he-sm { display:none; }
  th.he-sm, td.he-sm { display:none; }
  .toolbar { flex-direction: column; align-items: stretch; gap: 6px; }
  .toolbar input,
  .toolbar .btn {
    height: 30px;
    font-size: 16px; /* prevent iOS zoom */
    padding: 4px 8px;
    border-radius: 6px;
    line-height: 20px;
  }
  h1 { font-size: 18px; }
}
  </style>
</head>
  <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "adce69fde85645ce8c727fbe24b4811f"}'></script><!-- End Cloudflare Web Analytics -->
<body>
  <div class="container">
    <header>
      <h1>Global Semiconductor Industrial Policy Tracker</h1>
      <nav>
        <!-- Link back to your main personal site -->
        <a href="https://ranzhuo17.github.io/" title="Back to ranzhuo17.github.io">↩︎ Main site</a>
      </nav>
    </header>

    <p class="disclaimer">
  Data is compiled from publicly available sources and will be updated periodically.
  It may not be fully comprehensive, and some policies across regions or time periods may not be captured.
</p>

    <div id="app" class="card" aria-live="polite"></div>

  <script>
    // ================== DATA ==================
    // Minimal example data. Replace with your real entries.
    // : URL-safe entifier (unique), name: display name
    // country: string, year: number | string, total_amount: number (USD),
    // sources: optional array of {label, url},
    // distributions: array of rows shown on the detail page
    let SUBSIDIES = [];
async function loadData(){
  try{
    const res = await fetch('policies.json', { cache: 'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    SUBSIDIES = await res.json();
  }catch(err){
    console.error('Failed to load policies.json', err);
    SUBSIDIES = [];
    const app = document.getElementById('app');
    if(app && !app.dataset.errorShown){
      app.dataset.errorShown = '1';
      app.innerHTML = `<p class="muted">Couldn’t load data. Add <code>policies.json</code> (an array of policy objects) to populate this page.</p>`;
    }
  }
}

    // ================== UTILITIES ==================

    // ---- Sorting helpers ----
let sortState = { key: 'project_name', dir: 'asc' }; // default

const SORTABLE_COLS = [
  { key: 'project_name',      label: 'Project Name (Click for details)' },
  { key: 'subproject_name',   label: 'Subproject Name' },
  { key: 'year_announced',    label: 'Year Announced' },
  { key: 'effective_period',  label: 'Effective Period' },
  { key: 'country_region',    label: 'Country/Region' },
];

function startYearFromPeriod(val) {
  if (!val) return NaN;
  // Accept "YYYY", "YYYY-YYYY", "YYYY–YYYY" (en dash), extra text
  const m = String(val).match(/(\d{4})/);
  return m ? Number(m[1]) : NaN;
}

function compareValues(a, b, key) {
  if (key === 'year_announced') {
    const na = Number(a?.year_announced);
    const nb = Number(b?.year_announced);
    if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
    // fallback to text if not numeric
    return String(a?.year_announced ?? '').localeCompare(String(b?.year_announced ?? ''));
  }
  if (key === 'effective_period') {
    const sa = startYearFromPeriod(a?.effective_period);
    const sb = startYearFromPeriod(b?.effective_period);
    if (!Number.isNaN(sa) && !Number.isNaN(sb)) return sa - sb;
    return String(a?.effective_period ?? '').localeCompare(String(b?.effective_period ?? ''));
  }
  // default text compare
  return String(a?.[key] ?? '').localeCompare(String(b?.[key] ?? ''), undefined, { sensitivity: 'base' });
}

function toggleSort(key) {
  if (sortState.key === key) {
    sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
  } else {
    sortState = { key, dir: 'asc' };
  }
}

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const fmtMoney = n => {
      if (typeof n !== 'number' || Number.isNaN(n)) return '—';
      if (n >= 1e9) return `$${(n/1e9).toFixed(1)}B`;
      if (n >= 1e6) return `$${(n/1e6).toFixed(1)}M`;
      return `$${n.toLocaleString()}`;
    };

    function getRoute() {
      const hash = location.hash.replace(/^#\/?/, '');
      const [route, id] = hash.split('/');
      return { route: route || 'home', id };
    }

    function navigate(to) {
      location.hash = to;
    }

    // ================== RENDERERS ==================
   function renderHome() {
  const app = document.getElementById('app');
  app.innerHTML = '';

  // toolbar
  const toolbar = document.createElement('div');
  toolbar.className = 'toolbar';
  toolbar.innerHTML = `
    <input id="q" type="search" placeholder="Search project, subproject, country, year…" aria-label="Search policies" />
    <button class="btn" id="clearBtn" type="button">Clear</button>
  `;

  // table shell
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const tr = document.createElement('tr');

  // build sortable headers
  for (const col of SORTABLE_COLS) {
    const th = document.createElement('th');
    th.setAttribute('role', 'button');
    th.tabIndex = 0;
    th.dataset.key = col.key;
    th.title = 'Click to sort';
    th.innerHTML = `
      <span class="th-label">${col.label}</span>
      <span class="th-sort-ind" aria-hidden="true"></span>
    `;
    // click + keyboard
    th.addEventListener('click', () => { toggleSort(col.key); draw(qInput.value); });
    th.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSort(col.key); draw(qInput.value); }
    });
    tr.appendChild(th);
  }

  // Details (not sortable)
  const thDetails = document.createElement('th');
  thDetails.textContent = 'Details';
  tr.appendChild(thDetails);

  thead.appendChild(tr);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  tbody.id = 'rows';
  table.appendChild(tbody);

  app.append(toolbar, table);

  const rows = document.getElementById('rows');
  const qInput = document.getElementById('q');
  const clearBtn = document.getElementById('clearBtn');

  function updateHeaderIndicators() {
    // Clear all indicators and aria-sort
    table.querySelectorAll('th').forEach(th => {
      th.removeAttribute('aria-sort');
      const ind = th.querySelector('.th-sort-ind');
      if (ind) ind.textContent = '';
    });
    // Set current
    const active = table.querySelector(`th[data-key="${sortState.key}"]`);
    if (active) {
      active.setAttribute('aria-sort', sortState.dir === 'asc' ? 'ascending' : 'descending');
      const ind = active.querySelector('.th-sort-ind');
      if (ind) ind.textContent = sortState.dir === 'asc' ? ' ▲' : ' ▼';
    }
  }

  // draw with search + sort
  function draw(filter = '') {
    const q = (filter || '').trim().toLowerCase();

    // filter
    let items = (Array.isArray(SUBSIDIES) ? SUBSIDIES : []).filter(s => {
      if (!q) return true;
      const haystack = [
        s.project_name,
        s.subproject_name,
        s.country_region,
        s.effective_period,
        s.type_and_status,
        s.targeted_entities,
        s.notes,
        ...(Array.isArray(s.distributions) ? s.distributions.map(d => d.distribution_name) : [])
      ].filter(Boolean).join(' ').toLowerCase();
      return haystack.includes(q);
    });

    // stable sort: remember original index to break ties
    items = items
      .map((v, i) => ({ v, i }))
      .sort((A, B) => {
        const cmp = compareValues(A.v, B.v, sortState.key);
        if (cmp !== 0) return sortState.dir === 'asc' ? cmp : -cmp;
        return A.i - B.i;
      })
      .map(x => x.v);

    // render
    rows.innerHTML = items.map(s => `
      <tr>
        <td><a href="#/subsidy/${s.project_id}" aria-label="Open ${s.project_name}">${s.project_name ?? ''}</a></td>
        <td>${s.subproject_name ?? ''}</td>
        <td>${s.year_announced ?? ''}</td>
        <td>${s.effective_period ?? ''}</td>
        <td>${s.country_region ?? ''}</td>
        <td>${s.type_and_status ?? ''}</td>
        <td>${s.numbers ?? ''}</td>
        <td>${s.targeted_entities ?? ''}</td>
        <td class="muted"><a href="#/subsidy/${s.project_id}">Click to see details</a></td>
      </tr>
    `).join('');

    updateHeaderIndicators();
  }

  qInput.addEventListener('input', () => draw(qInput.value));
  clearBtn.addEventListener('click', () => { qInput.value = ''; draw(''); qInput.focus(); });

  draw('');
}



      const qInput = $('#q');
      const clearBtn = $('#clearBtn');
      qInput.addEventListener('input', () => draw(qInput.value));
      clearBtn.addEventListener('click', () => { qInput.value=''; draw(''); qInput.focus(); });

      draw('');
    }

  function normalizeSources(srcs) {
  if (!srcs) return [];

  // Already an array? great.
  if (Array.isArray(srcs)) return srcs;

  // Sometimes data comes as a stringified JSON array
  if (typeof srcs === 'string') {
    try {
      const maybe = JSON.parse(srcs);
      if (Array.isArray(maybe)) return maybe;
    } catch (_) {}

    const out = [];

    // 1) Markdown links: [Label](https://example.com,foo) — commas OK
    const mdRe = /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;
    let mdMatch;
    let consumed = srcs;
    while ((mdMatch = mdRe.exec(srcs)) !== null) {
      out.push({ label: mdMatch[1], url: mdMatch[2] });
      consumed = consumed.replace(mdMatch[0], ' ');
    }

    // 2) Bare URLs (don’t stop at commas; stop at whitespace or closing quotes/brackets)
    const urlRe = /https?:\/\/[^\s<>"')\]]+/g;
    let urlMatch;
    while ((urlMatch = urlRe.exec(consumed)) !== null) {
      out.push({ url: urlMatch[0] });
    }

    // 3) If we still have nothing, allow splitting on ; or |
    if (out.length === 0) {
      const parts = srcs.split(/\s*[;|]\s*/).filter(Boolean);
      for (const p of parts) {
        // Support "Label, https://..." (comma only as label/URL separator)
        const m = p.match(/^(.*?)\s*,\s*(https?:\/\/.+)$/);
        if (m) out.push({ label: m[1], url: m[2] });
        else if (/^https?:\/\//i.test(p)) out.push({ url: p });
        else out.push({ label: p });
      }
    }

    return out;
  }

  return [];
}

function renderSourcesList(srcs) {
  const items = normalizeSources(srcs);
  if (!items.length) return '';

  return items
    .map(s => {
      if (typeof s === 'string') {
        // If array contains raw strings
        return /^https?:\/\//i.test(s)
          ? `<a href="${s}" target="_blank" rel="noopener">${s}</a>`
          : s;
      }
      const text = s.label ?? s.url ?? '';
      const href = s.url;
      if (href && /^https?:\/\//i.test(href)) {
        return `<a href="${href}" target="_blank" rel="noopener">${text || href}</a>`;
      }
      // If no valid URL, just return the text
      return text;
    })
    .filter(Boolean)
    .join(' · ');
}


   function renderDetail(id) {
  const s = SUBSIDIES.find(x => String(x.project_id) === String(id));
  const app = $('#app');
  if (!s) {
    app.innerHTML = `<div class="breadcrumb"><a href="#/">← Back</a></div><p>Subsidy not found.</p>`;
    return;
  }

  app.innerHTML = `
    <div class="breadcrumb"><a href="#/">← Back to all policies</a></div>
    <h2 style="margin: 6px 0 16px; font-size: 22px;">${s.project_name}</h2>
    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom: 14px;">
      <span class="pill">🌍 ${s.country_region ?? ''}</span>
      <span class="pill">📅 ${s.effective_period ?? ''}</span>
      <span class="pill">💰 ${s.numbers ?? ''}</span>
      <span class="pill">📝 <strong>Details:</strong> ${s.notes ?? ''}</span>
    </div>
    ${s.sources ? `<div class="muted" style="margin-bottom:12px">
       Sources: ${renderSourcesList(s.sources)}
     </div>` : ''}

    <div class="card" style="padding:0; overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Distribution Name</th>
            <th>Year Announced</th>
            <th>Effective Period</th>
            <th>Country/Region</th>
            <th>Type & Status</th>
            <th>Numbers</th>
            <th>Targeted Entities</th>
            <th>Notes</th>
            <th>Sources</th>
          </tr>
        </thead>
        <tbody>
          ${(s.distributions ?? []).map(r => `
            <tr>
              <td>${r.distribution_name ?? ''}</td>
              <td>${r.year_announced ?? ''}</td>
              <td>${r.effective_period ?? ''}</td>
              <td>${r.country_region ?? ''}</td>
              <td>${r.type_and_status ?? ''}</td>
              <td>${r.numbers ?? ''}</td>
              <td>${r.targeted_entities ?? ''}</td>
              <td>${r.notes ?? ''}</td>
              <td>${renderSourcesList(r.sources || s.sources)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

    // ================== ROUTER ==================
    function router(){
      const { route, id } = getRoute();
      if (route === 'subsidy' && id) return renderDetail(id);
      return renderHome();
    }

    window.addEventListener('hashchange', router);
    window.addEventListener('DOMContentLoaded', async () => { await loadData(); router(); });
  </script>
</body>
</html>
